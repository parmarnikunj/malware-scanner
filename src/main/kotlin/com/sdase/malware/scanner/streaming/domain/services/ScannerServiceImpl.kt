package com.sdase.malware.scanner.streaming.domain.services

import com.sdase.malware.scanner.streaming.domain.connector.DocumentConnectorService
import com.sdase.malware.scanner.streaming.domain.model.*
import org.springframework.stereotype.Service
import java.nio.file.Files
import java.nio.file.Path

@Service
class ScannerServiceImpl(
    private val documentConnector: DocumentConnectorService,
    private val pdfService: PdfService,
    private val ibanService: IBANService,
    private val eventFactory: EventFactory
) : ScannerService {
    override fun scan(checkEvent: CheckEvent?) : CheckResultEvent {

        val document = documentConnector.getDocument(checkEvent!!.url)
        try {
            val iban = pdfService.findIBAN(document)
            val isBlackListed = ibanService.isBlacklisted(iban.value)

            val eventDetails = EventDetails(DocumentCheck(isBlackListed), checkEvent.url, "details")
            return eventFactory.createEvent(eventDetails)
        }finally {
            cleanUp(document)
        }
    }

    private fun cleanUp(document: Path) {
        Files.deleteIfExists(document)
    }
}