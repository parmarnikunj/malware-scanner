package com.sdase.malware.scanner.streaming.domain.services

import com.fasterxml.jackson.databind.ObjectMapper
import com.sdase.malware.scanner.streaming.domain.model.CheckEvent
import org.slf4j.Logger
import org.springframework.kafka.annotation.KafkaListener
import org.springframework.kafka.core.KafkaTemplate
import org.springframework.stereotype.Service

@Service
class ListenerServiceImpl(
    private val scannerService: ScannerService,
    private val kafkaTemplate: KafkaTemplate<String, String>,
    private val objectMapper: ObjectMapper,
    private val logger: Logger
): ListenerService {

    @KafkaListener(id = "myId", topics = ["scan_malware"])
    override fun listen(checkEventStr: String) {
        logger.info("event received : $checkEventStr")
        val checkEvent = objectMapper.readValue(checkEventStr, CheckEvent::class.java)
        val checkResultEvent = scannerService.scan(checkEvent)
        //kafkaTemplate.send("check_result_events", objectMapper.writeValueAsString(checkResultEvent))
    }
}