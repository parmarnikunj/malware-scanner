package com.sdase.malware.scanner.streaming.domain.services

import com.sdase.malware.scanner.streaming.domain.connector.DocumentConnectorService
import com.sdase.malware.scanner.streaming.domain.model.StateEnum
import com.sdase.malware.scanner.streaming.domain.services.Mothers.Companion.defaultCheckEvent
import io.mockk.every
import io.mockk.mockk
import io.mockk.verify
import org.assertj.core.api.Assertions.assertThat
import org.junit.jupiter.api.Test

class ScannerServiceImplTest {
    private val documentConnector = mockk<DocumentConnectorService>(relaxed = true)
    private val pdfService = mockk<PdfService>(relaxed = true)
    private val ibanService = mockk<IBANService>(relaxed = true)
    private val eventFactory = EventFactory()
    private val scannerService = ScannerServiceImpl(documentConnector,pdfService, ibanService, eventFactory)
    @Test
    fun `scan shall produce CheckResultEvent`() {

        every { ibanService.isBlacklisted(any()) } returns false
        val checkEvent = defaultCheckEvent()

        val checkResultEvent = scannerService.scan(checkEvent)

        verify { ibanService.isBlacklisted(any()) }
        verify { documentConnector.getDocument(checkEvent.url) }

        assertThat(checkResultEvent).isNotNull
        assertThat(checkResultEvent.name).isEqualTo(checkEvent.url)
        assertThat(checkResultEvent.stateEnum).isEqualTo(StateEnum.ERROR)
    }
}