package com.sdase.malware.scanner.streaming.domain.connector

import io.mockk.every
import io.mockk.mockk
import io.mockk.verify
import org.assertj.core.api.Assertions.assertThat
import org.junit.jupiter.api.Test
import org.springframework.core.io.ClassPathResource
import org.springframework.core.io.Resource
import org.springframework.core.io.buffer.DataBuffer
import org.springframework.core.io.buffer.DataBufferFactory
import org.springframework.core.io.buffer.DataBufferUtils
import org.springframework.core.io.buffer.DefaultDataBuffer
import org.springframework.core.io.buffer.DefaultDataBufferFactory
import org.springframework.web.reactive.function.client.WebClient
import reactor.core.publisher.Flux
import kotlin.io.path.Path

class DocumentConnectorServiceTest {

    private val webClient = mockk<WebClient>()

    private val documentConnectorService = DocumentConnectorService(webClient)

    @Test
    fun `it should retrive a document`() {
        val uri = "http://localhost:8080/docs/1234.pdf"
        every { webClient.get().uri(uri).retrieve().bodyToFlux(DataBuffer::class.java)} returns
                DataBufferUtils.read(
                    Path("src/test/resources/Testdaten_Rechnungseinreichung.pdf"),
                    DefaultDataBufferFactory(),
                    100
                )

        val document = documentConnectorService.getDocument(uri)

        verify { webClient.get() }
        assertThat(document).isNotNull
    }

    @Test
    fun `fetch filename from url`() {
        val url = "http://localhost:8080/documents/123456"

        val filename = url.split("/").last()

        assertThat(filename).isEqualTo("123456")

    }
}